import matplotlib.pyplot as plt
import pandas as pd
import os
from mpl_toolkits.mplot3d import Axes3D

def plot_marker_data(csv_path, output_plot_path):
    # Load data
    df = pd.read_csv(csv_path)
    
    # Extract columns
    fps = df["fps"]
    frames = df["Frame"]
    x_positions = df["X Position (m)"]
    y_positions = df["Y Position (m)"]
    seconds = frames * (1 / fps)  # Time in seconds
    
    # Create 3D plot
    fig = plt.figure(figsize=(10, 8))
    ax = fig.add_subplot(111, projection='3d')
    
    # Plot trajectory (X on x-axis, Time on y-axis, Y on z-axis)
    ax.plot(x_positions, seconds, y_positions,
            label='Trajectory', color='blue', linewidth=1.5)
    
    # Optional: Moving average (smoothed trajectory)
    window_size = int(fps.iloc[0] * 0.5)  # 0.5-second window
    moving_avg_x = x_positions.rolling(window=window_size).mean()
    moving_avg_y = y_positions.rolling(window=window_size).mean()
    ax.plot(moving_avg_x, seconds, moving_avg_y,
            label='Moving Average', color='orange', linewidth=2)
    
    # Configure axes
    ax.set_xlabel('X Position (m)')
    ax.set_ylabel('Time (s)')  # Now on y-axis
    ax.set_zlabel('Y Position (m)')  # Now on z-axis
    ax.set_title('3D Trajectory (X, Time, Y)')
    ax.legend()
    ax.grid(True)
    
    # Save plot
    plt.tight_layout()
    plt.savefig(output_plot_path)
    print(f"3D plot saved to {output_plot_path}")

if __name__ == "__main__":
    input_folder = os.path.join(os.path.dirname(__file__), 'output_files')
    output_folder = os.path.join(os.path.dirname(__file__), 'output_plots')
    os.makedirs(output_folder, exist_ok=True)
    
    for file_name in os.listdir(input_folder):
        if file_name.endswith('.csv'):
            csv_file = os.path.join(input_folder, file_name)
            plot_output = os.path.join(output_folder, file_name.replace('.csv', '_3d.png'))
            plot_marker_data(csv_file, plot_output)